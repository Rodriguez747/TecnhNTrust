<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Document Control</title>
  <link rel="stylesheet" href="css/documents.css" />
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter&display=swap');
    *, *::before, *::after {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: 'Inter', sans-serif, Arial, Helvetica, sans-serif;
      background-color: #896698;
      color: #111;
    }
    /* Sidebar */
    .sidebar {
      position: fixed;
      top: 0;
      left: 0;
      width: 220px;
      height: 100vh;
      background: #F3E4F9;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      padding: 20px 0;
    }
    .sidebar .logo {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-left: 20px;
      margin-bottom: 30px;
    }
    .sidebar .logo img {
      width: 40px;
      height: auto;
    }
    .sidebar .logo strong {
      font-weight: 700;
      font-size: 18px;
      color: #004080;
    }
    .sidebar nav ul {
      list-style: none;
      padding: 0;
      margin: 0 0 40px 0;
    }
    .sidebar nav ul li {
      padding: 14px 20px;
      font-size: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 500;
    }
    .sidebar nav ul li a {
      text-decoration: none;
      color: #111;
      flex-grow: 1;
    }
    .sidebar nav ul li:hover,
    .sidebar nav ul li.active {
      background: #E9D8F0;
      font-weight: 600;
    }
    .sidebar .user {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-left: 20px;
      color: #222;
    }
    .sidebar .user span {
      font-size: 24px;
    }
    .sidebar .user strong {
      font-weight: 600;
      font-size: 14px;
      display: block;
    }
    /* Main content */
    .main {
      margin-left: 220px;
      padding: 20px;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    header {
      background-color: #F3E4F9;
      color: black;
      font-weight: 600;
      font-size: 20px;
      border-radius: 8px;
      padding: 12px 20px;
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header .bell-icon {
      cursor: pointer;
      width: 24px;
      height: 24px;
      fill: #fff;
    }
    .section-title {
      font-weight: 700;
      font-size: 18px;
      margin-bottom: 12px;
      color: #111;
    }
    .buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 12px;
      justify-content: flex-end;
    }
    .btn-upload {
      background-color: #2563EB;
      border: none;
      border-radius: 6px;
      color: white;
      padding: 7px 14px;
      font-size: 14px;
      cursor: pointer;
      font-weight: 600;
    }
    .btn-upload:hover {
      background-color: #1E40AF;
    }
    .btn-filter {
      background-color: #9CA3AF;
      border: none;
      border-radius: 6px;
      color: black;
      padding: 7px 14px;
      font-size: 14px;
      cursor: pointer;
      font-weight: 600;
    }
    .btn-filter:hover {
      background-color: #6B7280;
      color: white;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
      background: white;
      border-radius: 8px;
      overflow: hidden;
    }
    thead tr {
      background-color: #F3E4F9;
    }
    thead th {
      font-weight: 600;
      padding: 14px 12px;
      text-align: left;
      color: #111;
      border: 1px solid #e5e7eb;
    }
    tbody td {
      padding: 12px;
      font-size: 14px;
      vertical-align: middle;
      border: 1px solid #e5e7eb;
      background-color: #fff;
      color: #111;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    tbody td.document {
      font-weight: 700;
      white-space: normal;
    }
    .actions {
      white-space: nowrap;
    }
    .actions a {
      font-weight: 600;
      color: #2563EB;
      text-decoration: none;
      margin-right: 10px;
      cursor: pointer;
    }
    .actions a:last-child {
      color: #222;
      font-weight: 700;
    }
    .actions a:hover {
      text-decoration: underline;
    }
    tbody td.status {
      font-weight: 700;
    }
    .dash {
      color: #999;
      font-weight: 600;
    }
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    /* Modal styling */
    #uploadModal, #viewModal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 999;
      justify-content: center;
      align-items: center;
    }
    #uploadModal > div, #viewModal > div {
      background: white;
      padding: 20px;
      border-radius: 10px;
      width: 400px;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <div>
      <div class="logo">
        <img src="img/LOGO.png" alt="Logo" />
        <strong>ComplyTeam</strong>
      </div>
      <nav>
        <ul>
          <li><span>üè†</span> <a href="regulatory.html">Dashboard</a></li>
          <li><span>üîç</span> <a href="audit.html">Audit Logs</a></li>
          <li><span>‚ö†Ô∏è</span> <a href="findings.html">Findings</a></li>
          <li class="active"><span>üìÅ</span> <a href="documents.html">Documents</a></li>
          <li><span>üö©</span> <a href="incident.html">Incidents</a></li>
        </ul>
      </nav>
    </div>
    <div class="user">
      <span>üë§</span>
      <div>
        <strong>Jasper John Dreo</strong>
        <small>Compliance</small>
      </div>
    </div>
  </div>

  <div class="main" role="main" aria-label="Document control main content">
    <header>
      <div>Document Control</div>
      <svg class="bell-icon" role="img" aria-label="Notifications" viewBox="0 0 24 24">
        <path d="M12 22c1.1 0 2-.9 2-2h-4a2 2 0 0 0 2 2zm6-6v-5c0-3.07-1.63-5.64-4.5-6.32V4a1.5 1.5 0 1 0-3 0v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"/>
      </svg>
    </header>
    <section aria-labelledby="findings-title" style="background: #fff; border-radius: 8px; padding: 20px;">
      <div class="section-header">
        <h2 class="section-title" id="findings-title">Documents</h2>
        <div class="buttons">
          <button class="btn-upload" type="button">+ Upload</button>
          <button class="btn-filter" type="button">Filter</button>
        </div>
      </div>

      <table aria-describedby="findings-title">
        <thead>
          <tr>
            <th>Document Name</th>
            <th>Department Owner</th>
            <th>Document Approved</th>
            <th>Status</th>
            <th>Last Validated</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <!-- Documents will load here -->
        </tbody>
      </table>
    </section>
  </div>

  <!-- Upload Modal -->
  <div id="uploadModal">
    <div>
      <h3 style="margin-top: 0;">Upload Document</h3>
      <form id="uploadForm" enctype="multipart/form-data">
        <label>Document Name</label>
        <input type="text" name="document_name" required style="width: 100%; margin-bottom: 10px;"><br>
        <label>Department Owner</label>
        <select name="owner_dept" required style="width: 100%; margin-bottom: 10px;">
          <option value="">Select Department</option>
          <option value="HR">HR</option>
          <option value="Project Management">Project Management</option>
          <option value="Sales & CRM">Sales & CRM</option>
          <option value="Manufacturing & Production Mgmt.">Manufacturing & Production Mgmt.</option>
          <option value="Inventory & Warehouse Mgmt.">Inventory & Warehouse Mgmt.</option>
          <option value="Procurement">Procurement</option>
          <option value="Finance and Accounting">Finance and Accounting</option>
          <option value="Compliance & Risk Mgmt.">Compliance & Risk Mgmt.</option>
          <option value="B.I. and Analytics">B.I. and Analytics</option>
          <option value="IT">IT</option>
          <option value="Marketing">Marketing</option>
          <option value="Customer Service & Support">Customer Service & Support</option>
        </select><br>
        <label>Choose File</label>
        <input type="file" name="file" required accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.jpg,.jpeg,.png" style="margin-bottom: 10px;"><br>
        <button type="submit" style="background: #2563EB; color: white; border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer;">Upload</button>
        <button type="button" id="uploadCancel" style="margin-left: 10px; padding: 10px 15px; border-radius: 6px; cursor: pointer;">Cancel</button>
      </form>
    </div>
  </div>

  <!-- View Modal -->
  <div id="viewModal" role="dialog" aria-modal="true" aria-labelledby="viewModalTitle">
    <div>
      <h3 id="viewModalTitle" style="margin-top: 0;">Document Details</h3>
      <div id="viewDetails" style="margin-bottom: 15px;"></div>
      <div id="filePreview" style="margin-bottom: 15px;"></div>
      <button id="closeViewModal" style="background: #2563EB; color: white; border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer;">Close</button>
    </div>
  </div>

  <script>
  // Show upload modal
  const modal = document.getElementById('uploadModal');
  const uploadBtn = document.querySelector('.btn-upload');
  uploadBtn.addEventListener('click', () => modal.style.display = 'flex');

  // Close upload modal
  function closeModal() {
    modal.style.display = 'none';
  }

  // Submit upload form
  document.getElementById('uploadForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const form = e.target;
    const formData = new FormData(form);

    try {
      const res = await fetch('http://localhost:3000/upload', {
        method: 'POST',
        body: formData
      });

      if (res.ok) {
        alert('‚úÖ Document uploaded!');
        closeModal();
        form.reset();
        fetchDocuments(); // Refresh
      } else {
        alert('‚ùå Upload failed.');
      }
    } catch (err) {
      alert('‚ùå Upload error.');
      console.error(err);
    }
  });

  // Load documents into table
  async function fetchDocuments() {
    try {
      const res = await fetch('http://localhost:3000/documents');
      if (!res.ok) throw new Error('Failed to fetch');

      const docs = await res.json();
      const tbody = document.querySelector('table tbody');
      tbody.innerHTML = '';

      docs.forEach(doc => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="document">${doc.document_name}</td>
          <td>${doc.owner_dept}</td>
          <td>${doc.document_approved ? new Date(doc.document_approved).toLocaleDateString() : '<span class="dash">-</span>'}</td>
          <td class="status">${doc.approval_status || '<span class="dash">-</span>'}</td>
          <td>${doc.last_review ? new Date(doc.last_review).toLocaleDateString() : '<span class="dash">-</span>'}</td>
          <td class="actions">
            <a href="#" onclick="viewDocument(${doc.document_id}); return false;">View</a>
            <a href="#" onclick="editDocument(${doc.document_id}); return false;">Edit</a>
            <a href="http://localhost:3000/download/${doc.document_id}" target="_blank" download>Download</a>
            <a href="#" onclick="deleteDocument(${doc.document_id}); return false;">Delete</a>
          </td>
        `;
        tbody.appendChild(tr);
      });
    } catch (err) {
      console.error('Error loading documents:', err);
    }
  }

  // View modal logic
  function closeViewModal() {
    document.getElementById('viewModal').style.display = 'none';
    document.getElementById('filePreview').innerHTML = '';
  }

  async function viewDocument(id) {
    try {
      const res = await fetch(`http://localhost:3000/document/${id}`);
      if (!res.ok) throw new Error('Document not found');

      const doc = await res.json();

      const detailsHTML = `
        <p><strong>Document Name:</strong> ${doc.document_name}</p>
        <p><strong>Department:</strong> ${doc.owner_dept}</p>
        <p><strong>Status:</strong> ${doc.approval_status || '-'}</p>
        <p><strong>Approved On:</strong> ${doc.document_approved ? new Date(doc.document_approved).toLocaleDateString() : '-'}</p>
        <p><strong>Last Reviewed:</strong> ${doc.last_review ? new Date(doc.last_review).toLocaleDateString() : '-'}</p>
      `;
      document.getElementById('viewDetails').innerHTML = detailsHTML;

      const filePreviewDiv = document.getElementById('filePreview');
      if (doc.file_name) {
        const fileExt = doc.file_name.split('.').pop().toLowerCase();
        const fileUrl = `http://localhost:3000/download/${id}`;

        if (fileExt === 'pdf') {
          filePreviewDiv.innerHTML = `
            <strong>File Preview:</strong><br>
            <iframe src="${fileUrl}" width="100%" height="500px" style="border: 1px solid #ccc;"></iframe>
            <p><a href="${fileUrl}" target="_blank" rel="noopener noreferrer">Open PDF in new tab</a></p>
          `;
        } else {
          filePreviewDiv.innerHTML = `
            <strong>File:</strong> <a href="${fileUrl}" target="_blank" rel="noopener noreferrer" download>Download File</a>
          `;
        }
      } else {
        filePreviewDiv.innerHTML = `<p><em>No file uploaded.</em></p>`;
      }

      document.getElementById('viewModal').style.display = 'flex';

    } catch (err) {
      console.error('Error loading document details:', err);
      alert('‚ö†Ô∏è Failed to load document details.');
    }
  }

  // Edit placeholder
  function editDocument(id) {
    alert(`Edit function not implemented yet. Document ID: ${id}`);
  }

  // Delete document
  async function deleteDocument(id) {
    if (confirm('Are you sure you want to delete this document?')) {
      try {
        const res = await fetch(`http://localhost:3000/document/${id}`, {
          method: 'DELETE'
        });
        if (res.ok) {
          alert('‚úÖ Document deleted.');
          fetchDocuments(); // Refresh
        } else {
          alert('‚ùå Failed to delete document.');
        }
      } catch (err) {
        console.error('Delete error:', err);
        alert('‚ùå Error occurred.');
      }
    }
  }

  // Close modals when clicking outside
  window.onclick = function(event) {
    if (event.target === modal) closeModal();
    if (event.target === document.getElementById('viewModal')) closeViewModal();
  };

  // Initial load
  fetchDocuments();
</script>

</body>
</html>
